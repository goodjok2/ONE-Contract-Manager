# Phase E: Fix Saved Contract Viewer & Preview Logic

**Context:**
The database schema has been refactored to use "Atomic Clauses" (`header_text` and `body_html`), replacing the old `content` column.
However, the endpoints responsible for **Viewing Saved Contracts** and **Generating Previews** have not been updated. They are likely returning `null` or crashing because they are looking for the legacy `content` field. We need to "shim" these endpoints to reconstruct the HTML dynamically.

**Task 1: Update Contract Viewer API (`server/routes/projects.ts` and `server/routes/contracts.ts`)**
- Locate the endpoints used to fetch project contracts (e.g., `GET /api/projects/:id`, `GET /api/projects/:id/contract`, or `GET /api/contracts/:id`).
- **Update the SQL Query:** Ensure the query joins the `clauses` table and selects `headerText`, `bodyHtml`, `level`, `order`, and `slug`.
- **Reconstruct the Legacy `content` Field:**
  - Map the response data before sending it to the frontend.
  - Create a synthetic `content` field for each clause:
    ```javascript
    // Dynamic Reconstruction
    const content = `
      <div class="clause-wrapper level-${c.level}">
        <h4 class="clause-header">${c.headerText || ''}</h4>
        <div class="clause-body">${c.bodyHtml || ''}</div>
      </div>`;
    ```
  - This ensures the Frontend Viewer (which expects a `content` string) renders the document correctly without needing a full client-side rewrite.

**Task 2: Update Generator Preview Logic (`server/routes/generate.ts`)**
- Locate the clause generation logic used for the "PDF Preview" or "HTML Preview".
- **Switch to Atomic Fields:**
  - Replace any reference to `clause.content` with logic that uses `clause.headerText` and `clause.bodyHtml`.
  - **Apply Styling:**
    - If `level === 4` (Parent): Render header as **Heading 4** (Blue/Bold).
    - If `level === 5` (Child): Render header as **Heading 5** (Black/Bold) + Body Text.
    - If `level === 6` (Conspicuous): Render header as **ALL CAPS BOLD**.

**Task 3: Update `client/src/pages/ContractViewer.tsx` (if applicable)**
- If the frontend viewer component specifically requests fields by name, update it to request `header_text` and `body_html` in addition to `content`.
- Ensure it renders the reconstructed HTML safely.

**Goal:**
- The "Saved Contracts" page must load immediately.
- The "Preview" modal must show formatted text (Blue Headers, Black Body), not raw HTML tags.
- No "Internal Server Error" or "Undefined" messages when loading a project.