# REPLIT AGENT PROMPT — CONTRACT OUTPUT BUG FIXES (Post Prompt 1 & 2)

## CONTEXT

Prompts 1 (hierarchy numbering) and 2 (exhibit content) have been run. The main body `1) a. i.` numbering and exhibit structure are now in place. This prompt fixes the remaining issues visible in the generated output. Work through each fix in order, testing as you go.

---

## FIX 1: TITLE PAGE — Project number/name on new line

**File:** `server/lib/contractGenerator.ts` (title page rendering)

**Current output:**
```
CONTRACT AGREEMENT - 2024-010 - 900 WQ LLC
February 13, 2026
```

**Required output:**
```
CONTRACT AGREEMENT
2024-010 - 900 WQ LLC
February 13, 2026
```

The project number and name should be on a separate line below "CONTRACT AGREEMENT". Find the title page rendering and split into three lines:
- Line 1: "CONTRACT AGREEMENT" (large, bold)
- Line 2: `{{PROJECT_NUMBER}} - {{PROJECT_NAME}}` (medium, normal weight)
- Line 3: Date (smaller)

---

## FIX 2: INLINE HEADER + CONTENT (no carriage return between header and body)

**File:** `server/lib/contractGenerator.ts` (renderBlockNode or equivalent)

**Problem:** When a clause has BOTH a header/name AND body content, they currently render on separate lines:

```
i.
Exhibit A controls solely for project scope, phasing, milestones...
```

or:

```
a. Exhibits Incorporated.
The following exhibits are attached to and incorporated...
```

**Required:** Header and content should be INLINE — on the same line, with the header underlined and non-bold, followed immediately by the content in plain text:

```
i. Exhibit A controls solely for project scope, phasing, milestones...
```

```
a. Exhibits Incorporated. The following exhibits are attached to and incorporated...
```

### Formatting Rules:

**For Level 2 (a. b. c.) items:**
```
[marker] [Header Name underlined, non-bold]. [Body content in plain text, same line]
```
- The header name (clauseName) is underlined but NOT bold
- A period and space follow the header
- Body content starts immediately after on the SAME line
- If body content wraps, subsequent lines align with the start of the header text (not the marker)

**For Level 3 (i. ii. iii.) items:**
- If the item has a header name AND body content: same inline treatment as Level 2
- If the item has ONLY body content (no header): content starts right after the marker
- If the item has ONLY a header (no body): just render the header after the marker

**CSS changes needed:**
```css
/* Level 2 sub-section header: underlined, non-bold */
.level-2-header {
  text-decoration: underline;
  font-weight: normal;
}

/* Level 2 body content: plain text, same line */
.level-2-content {
  font-weight: normal;
}
```

**For legal imperative text** (ALL CAPS content like warranty disclaimers):
- Keep the text bold
- But the preceding header is still underlined, non-bold

**HTML rendering example for Level 2:**
```html
<div class="level-2">
  <span class="level-2-marker">a.</span>
  <span class="level-2-header">Exhibits Incorporated.</span>
  <span class="level-2-content"> The following exhibits are attached to and incorporated into this Agreement:</span>
</div>
```

**HTML rendering example for Level 3 with header:**
```html
<div class="level-3">
  <span class="level-3-marker">i.</span>
  <span class="level-3-header">Exhibit A.</span>
  <span class="level-3-content"> Project Scope and Commercial Terms (Project/Phase Matrix; Milestones; Pricing; Payment Schedule; Completion Model election)</span>
</div>
```

**HTML rendering example for Level 3 WITHOUT header (just content):**
```html
<div class="level-3">
  <span class="level-3-marker">i.</span>
  <span class="level-3-content">Exhibit A controls solely for project scope, phasing, milestones, pricing, payment terms, delivery parameters, and site/completion model elections.</span>
</div>
```

---

## FIX 3: SECTION 14 SIGNATURES — Remove unformatted block, keep formatted one

**File:** `server/lib/contractGenerator.ts` (signature rendering)

**Problem:** The output currently shows TWO signature sections for Section 14:
1. An unformatted version with raw underscores (from the DOCX template clause content)
2. A nicely formatted signature block (generated by the renderer)

**Fix:** Keep ONLY the formatted signature block. Remove or suppress the raw underscore-based signature content that comes from the clause text. 

Look for where the Section 14 clause content is rendered. The clause likely has raw text like:
```
Signature: ___________________________
Name (Print): ________________________
```

Either:
- Strip this content from the Section 14 clause before rendering (detect "Signature: ___" pattern)
- Or skip rendering body content for the signature section clause and rely solely on the generated signature block

The formatted signature block should have:
- Two columns: COMPANY on left, CLIENT on right
- Each column: Signature line, Name, Title, Date
- Clean horizontal lines for signatures

---

## FIX 4: EXHIBIT A.1 — Unresolved SITE variables

**File:** `server/lib/mapper.ts` or `server/lib/contractGenerator.ts` (variable map)

**Problem:** The "Site(s)" row in Exhibit A.1 outputs:
```
2700 E Willamette Lane, Greenwood Village, CO 80121, {{SITE_CITY}}, {{SITE_STATE}} {{SITE_ZIP}}
```

The full address is already present in the first part. The `{{SITE_CITY}}`, `{{SITE_STATE}}`, `{{SITE_ZIP}}` variables are being appended redundantly AND not resolving.

**Fix (two parts):**

**Part A:** Make sure SITE_CITY, SITE_STATE, SITE_ZIP are mapped in the variable mapper:
```typescript
map['SITE_CITY'] = projectData.siteCity || projectData.city || '';
map['SITE_STATE'] = projectData.siteState || projectData.state || '';
map['SITE_ZIP'] = projectData.siteZip || projectData.zip || '';
```

**Part B:** Check the Exhibit A template/clause for the Site(s) row. If the address variable already includes the full address (street, city, state, zip), then the template should NOT also append separate city/state/zip variables. Fix the source — either:
- Use `{{SITE_ADDRESS}}` which contains the full formatted address, OR
- Use `{{SITE_STREET}}, {{SITE_CITY}}, {{SITE_STATE}} {{SITE_ZIP}}` as separate components

Do NOT use both the full address AND the individual components.

---

## FIX 5: EXHIBIT A.2 — One row per unit model with quantity column

**File:** `server/lib/tableGenerators.ts` or wherever the A.2 Property & Phase Matrix table is generated

**Problem:** Currently shows one combined row: `1x Gabriel, 3x Lumina`

**Required:** Separate row per model with a Quantity column:

```
| Property ID | Site Address | Phase | Model   | Qty | Est. Factory Start | ... |
|-------------|-------------|-------|---------|-----|-------------------|-----|
| P-1         | 2700 E...   | Ph 1  | Gabriel | 1   |                   |     |
| P-1         | 2700 E...   | Ph 1  | Lumina  | 3   |                   |     |
```

**Implementation:**
In the table generator, when building A.2 rows, iterate over the project's units. Group by model name and create one row per unique model with a count:

```typescript
// Pseudo-code for A.2 table generation
const unitsByModel = groupBy(projectUnits, 'modelName');

for (const [modelName, units] of Object.entries(unitsByModel)) {
  rows.push({
    propertyId: 'P-1',
    siteAddress: projectData.siteAddress,
    phase: 'Phase 1',
    model: modelName,
    quantity: units.length,
    estFactoryStart: '',
    estFactoryComplete: '',
    estDeliveryWindow: '',
    targetCO: '',
  });
}
```

Add a `Qty` column header between "Home/Model" and "Est. Factory Start".

---

## FIX 6: EXHIBIT A.4 — Consistent currency formatting

**File:** `server/lib/tableGenerators.ts` or wherever the A.4 pricing table is generated

**Problem:** Prices are inconsistently formatted:
```
Design / Pre-Production Fee    32000          ← missing $ and comma
Offsite Services (Factory)     $2,197,946.67  ← has cents
Total Project Price            $2,229,946.67  ← has cents
```

**Required:** ALL prices should be:
- Rounded to the nearest dollar (no cents)
- Include `$` prefix
- Include comma separators

```
Design / Pre-Production Fee    $32,000
Offsite Services (Factory)     $2,197,947
Total Project Price            $2,229,947
```

**Fix:** Apply a consistent currency formatter to ALL price values in the pricing table:

```typescript
function formatCurrencyWhole(value: number | string): string {
  const num = typeof value === 'string' ? parseFloat(value) : value;
  if (isNaN(num) || num === 0) return '$0';
  return '$' + Math.round(num).toLocaleString('en-US');
}
```

Apply this to every price cell in the A.4 pricing summary table AND the A.5 payment schedule table.

---

## FIX 7: EXHIBIT A.5 — Fix the blue-header payment table, remove the duplicate

**File:** `server/lib/tableGenerators.ts` or wherever the A.5 payment table is generated

**Problem:** There are TWO payment tables:
1. First table (blue header): has the right structure (Property ID, Phase, Payment, Trigger, Amount, Due) but the Amount column is EMPTY
2. Second table (black header): has correct amounts but is a duplicate with different formatting

**Fix:**
1. **Populate the first table** — the blue-header table needs to pull amounts from the payment schedule data. The milestone amounts should come from the pricing engine's payment schedule calculation.
2. **Add a Percentage column** to the first table: `| ... | % | Amount | Due |`
3. **Remove the second table entirely** — delete the code that generates the black-header summary table below it

The correct single table should look like:

```
| Property ID | Phase | Payment           | Trigger                | %   | Amount     | Due       |
|------------|-------|-------------------|------------------------|-----|------------|-----------|
| P-1        | 1     | Design Fee        | Execution              | -   | $32,000    | Immediate |
| P-1        | 1     | Green Light       | Green Light Notice     | 20% | $445,989   |           |
| P-1        | 1     | Factory Start     | First module fab       | 20% | $445,989   |           |
| P-1        | 1     | Factory Complete  | Dvele certification    | 20% | $445,989   |           |
| P-1        | 1     | Delivery / Set    | Delivery/set complete  | 15% | $334,492   |           |
| P-1        | 1     | Retainage         | CO/Equivalent          | 5%  | $111,497   |           |
|            |       |                   | **Total**              |100% |$2,229,947  |           |
```

Use the same `formatCurrencyWhole()` function from Fix 6.

---

## FIX 8: EXHIBIT A.8 — Formatted signature blocks

**File:** Wherever the Exhibit A signature blocks are rendered

**Problem:** The Exhibit A signature area has unformatted text with raw underscores for both pre- and post-Greenlight signatures.

**Required:** Replace with a compact, formatted dual-column signature block matching the Section 14 style but more compact:

```html
<table style="width:100%; margin-top:20pt; border-collapse:collapse;">
  <tr>
    <td style="width:48%; vertical-align:top; padding:10pt;">
      <p style="font-weight:bold; margin-bottom:8pt;">Accepted and agreed:</p>
      <p style="margin-bottom:4pt;">DVELE, INC.</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">By:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Name:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Title:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Date:</p>
      <br/>
      <p style="margin-bottom:4pt;">Client</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">By:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Name:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Title:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Date:</p>
    </td>
    <td style="width:4%;"></td>
    <td style="width:48%; vertical-align:top; padding:10pt;">
      <p style="font-weight:bold; margin-bottom:8pt;">Post Design Approval (Greenlight):</p>
      <p style="margin-bottom:4pt;">DVELE, INC.</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">By:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Name:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Title:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Date:</p>
      <br/>
      <p style="margin-bottom:4pt;">Client</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">By:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Name:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Title:</p>
      <p style="border-bottom:1pt solid #000; margin-bottom:4pt; padding-bottom:16pt;">Date:</p>
    </td>
  </tr>
</table>
```

Remove the raw underscore text blocks that currently appear.

---

## FIX 9: EXHIBIT B.1 — One row per model with quantity column

**File:** Same table generator area as Fix 5

**Problem:** Same as A.2 — shows combined models instead of individual rows. Also says "No units configured" in the Plan Set Version column.

**Required:** Same pattern as A.2:

```
| Property ID | Phase | Model   | Qty | Plan Set Version | Date | Third-Party Review |
|------------|-------|---------|-----|-----------------|------|--------------------|
| P-1        | 1     | Gabriel | 1   |                 |      |                    |
| P-1        | 1     | Lumina  | 3   |                 |      |                    |
```

Remove the "No units configured" text — leave cells blank if no version data exists.

---

## FIX 10: SECTION 13a — Cross-reference still says "Sections 3.4–3.9"

**File:** `server/lib/mapper.ts` (variable map)

**Problem:** Section 13.a still reads:
```
...provided no amendment modifies Sections 3.4–3.9 (bankability provisions) unless expressly stated.
```

This should reference the new numbering scheme: "Section 3.d through 3.i" (sub-sections d through i of section 3, which are the bankability provisions: Irrevocable Payment, No Setoff, Reimbursables, Late Payments, Assignment/Financing, Financing Party Cure).

**Fix:** In the variable mapper:
```typescript
map['XREF_FEES_PAYMENT_SECTION'] = '3';
map['XREF_BANKABILITY_SUBSECTIONS'] = '3.d through 3.i';
```

Also check Section 13.c which references "Section 3.8" — this should become "Section 3.h":
```typescript
map['XREF_ASSIGNMENT_SECTION'] = '3.h';
```

---

## FIX 11: SECTION 14 — Company name wrong in signature block

**Problem:** The Section 14 signature shows:
```
COMPANY:
900 WQ LLC  ← This is the PROJECT NAME, not the company name
```

It should show the SPV or Dvele entity name, not the project name. Check what variable is being used for the company signature block and ensure it uses `{{DVELE_PARTNERS_XYZ_LEGAL_NAME}}` or `{{COMPANY_NAME}}`, not `{{PROJECT_NAME}}`.

---

## ITEMS NOTED FOR FUTURE PROMPTS (do NOT implement now)

These items require wizard UI changes or new data infrastructure. Document them as TODO comments in the code but do not implement in this prompt:

- **C.2 Responsibility Matrix** — needs wizard UI for CMOS/CRC/manual selection of checkboxes
- **C.4 Interfaces & Dependencies** — deadline values need wizard inputs  
- **D.1/D.2 Target Dates** — need wizard date picker inputs
- **B.2 Specifications** — pending integration with dpp.dvele.io spec review
- **E.1 Statutory notice** — state-dependent content (see Fix 12 below)
- **F.2 State-specific provisions** — state-dependent content (see Fix 12 below)

---

## FIX 12: STATE-SPECIFIC CONTENT (Exhibits E and F)

**File:** `server/lib/contractGenerator.ts` (state disclosure resolution) and potentially `state_disclosures` table

**Problem:** The state-specific conditional system that existed in the original ONE Agreement has been lost in the Master EF contract. Exhibit E should show state-specific statutory notices (the Cal. Com. Code notice only applies to California projects, not Colorado ones). Exhibit F should show the correct state notice.

**This is a known architectural gap.** The system has two mechanisms:
1. `[STATE_DISCLOSURE:KEY]` tags in clause content
2. `state_disclosures` database table

**For now, implement a minimal fix:**

Check if the `state_disclosures` table has any rows. If empty, seed it with at least these entries:

```sql
INSERT INTO state_disclosures (state_code, disclosure_code, content, is_active) VALUES
('CA', 'WARRANTY_NOTICE', 'PURSUANT TO CAL. COM. CODE § 1201(b)(10), THIS SECTION (ALONG WITH SECTION 6, ABOVE) CHANGES YOUR EXISTING WARRANTY RIGHTS UNDER CALIFORNIA LAW, AND REPLACES CERTAIN EXISTING WARRANTIES WITH OUR OWN LIMITED WARRANTY. PLEASE READ THE ENTIRE SECTION CAREFULLY AND INITIAL AFTER READING ONLY IF YOU AGREE. YOU HAVE THE RIGHT TO CONSULT WITH AN ATTORNEY BEFORE AGREEING TO WAIVE THESE RIGHTS.', true),
('AZ', 'WARRANTY_NOTICE', 'ARIZONA NOTICE: This warranty is provided in accordance with Arizona consumer protection law. This section modifies your warranty rights. Please read carefully.', true),
('CO', 'WARRANTY_NOTICE', 'COLORADO NOTICE: This warranty is provided in accordance with Colorado consumer protection law. This section modifies your warranty rights. Please read carefully.', true),
('CA', 'STATE_PROVISION', 'CALIFORNIA NOTICE: This transaction may be subject to the California Contractors State License Board requirements. Verify contractor licensing at www.cslb.ca.gov.', true),
('AZ', 'STATE_PROVISION', 'ARIZONA NOTICE: This transaction is subject to the Arizona Registrar of Contractors requirements. Verify contractor licensing at www.azroc.gov.', true),
('CO', 'STATE_PROVISION', 'COLORADO NOTICE: Buyer acknowledges receipt of required Colorado disclosures regarding modular construction.', true);
```

Then ensure the Exhibit E and F rendering code:
1. Reads the project's state from `{{PROJECT_STATE}}` variable
2. Queries the `state_disclosures` table for that state
3. Injects the appropriate content

If the state_disclosures table doesn't exist, check the schema and create it:

```sql
CREATE TABLE IF NOT EXISTS state_disclosures (
  id SERIAL PRIMARY KEY,
  state_code VARCHAR(2) NOT NULL,
  disclosure_code VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**For Exhibit E:** Replace the hardcoded Cal. Com. Code notice with a dynamic lookup:
```typescript
const warrantyNotice = await getStateDisclosure(projectState, 'WARRANTY_NOTICE');
if (warrantyNotice) {
  // Render the statutory notice box with warrantyNotice.content
}
```

**For Exhibit F:** Replace hardcoded state notice with:
```typescript
const stateProvision = await getStateDisclosure(projectState, 'STATE_PROVISION');
if (stateProvision) {
  // Render in F.2 section
}
```

---

## VERIFICATION CHECKLIST

After implementing all fixes, generate a test contract and verify:

1. ✅ Title page: "CONTRACT AGREEMENT" on line 1, project number/name on line 2, date on line 3
2. ✅ Level 2 items: header is underlined non-bold, content follows on same line
3. ✅ Level 3 items without headers: content starts right after the marker (no empty line)
4. ✅ Section 14: only ONE formatted signature block (no raw underscores)
5. ✅ Exhibit A.1 Site(s): no unresolved {{SITE_CITY}} etc. — clean address only
6. ✅ Exhibit A.2: separate row per model with Qty column
7. ✅ Exhibit A.4: all prices show $X,XXX format (no cents, consistent formatting)
8. ✅ Exhibit A.5: ONE payment table with % column and populated amounts
9. ✅ Exhibit A.8: formatted dual-column signature blocks
10. ✅ Exhibit B.1: separate row per model with Qty column, no "No units configured"
11. ✅ Section 13.a: references "Section 3.d through 3.i" (not "3.4–3.9")
12. ✅ Section 13.c: references "Section 3.h" (not "3.8")
13. ✅ Section 14 signature: Company name is SPV/Dvele entity, not project name
14. ✅ Exhibit E: shows correct state-specific warranty notice (not CA notice for CO project)
15. ✅ Exhibit F: shows correct state provision for the project's state
